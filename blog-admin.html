<!DOCTYPE html>
<html>
<head>
    <title>CalculiQ Blog Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: #1a1f3a;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #646cff;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #646cff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5661ff;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .posts-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }
        
        .post-row {
            display: grid;
            grid-template-columns: 1fr 120px 100px 150px;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
            transition: background 0.2s;
        }
        
        .post-row:hover {
            background: #f8f9fa;
        }
        
        .post-title {
            font-weight: 600;
            color: #1a1f3a;
            margin-bottom: 5px;
        }
        
        .post-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .post-category {
            display: inline-block;
            padding: 4px 12px;
            background: #646cff;
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .post-date {
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .post-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .btn-small {
            padding: 5px 12px;
            font-size: 0.85rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #1a1f3a;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .post-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .post-actions {
                justify-content: flex-start;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù CalculiQ Blog Admin</h1>
        <p>Manage your blog posts, edit titles, and track performance</p>
    </div>
    
    <div class="container">
        <!-- Statistics -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="totalPosts">-</div>
                <div class="stat-label">Total Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalViews">-</div>
                <div class="stat-label">Total Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayPosts">-</div>
                <div class="stat-label">Today's Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgViews">-</div>
                <div class="stat-label">Avg Views/Post</div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="Search posts by title..." onkeyup="filterPosts()">
            <button class="btn btn-success" onclick="refreshPosts()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="generateNewPost()">‚ú® Generate New Post</button>
        </div>
        
        <!-- Posts Table -->
        <div class="posts-table">
            <div class="table-header">
                Blog Posts
            </div>
            <div id="postsList" class="loading">
                Loading posts...
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Blog Post</h2>
            </div>
            
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="editTitle" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Excerpt</label>
                    <textarea class="form-textarea" id="editExcerpt" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="editCategory">
                        <option value="Mortgage">Mortgage</option>
                        <option value="Investment">Investment</option>
                        <option value="Loan">Loan</option>
                        <option value="Insurance">Insurance</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Replace the JavaScript section in your blog-admin.html with this updated code
const API_BASE = '';
let allPosts = [];
let currentEditSlug = '';

// Load posts on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadPosts();
});

async function loadStats() {
    try {
        const response = await fetch('/api/blog-stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalPosts').textContent = data.stats.totalPosts || '0';
            document.getElementById('totalViews').textContent = data.stats.totalViews || '0';
            document.getElementById('avgViews').textContent = data.stats.averageViews || '0';
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadPosts() {
    try {
        const response = await fetch('/api/blog-posts-admin');
        const data = await response.json();
        
        if (data.success) {
            allPosts = data.posts;
            displayPosts(allPosts);
            
            // Update today's posts count
            const todayCount = allPosts.filter(post => {
                const postDate = new Date(post.published_at).toDateString();
                const today = new Date().toDateString();
                return postDate === today;
            }).length;
            document.getElementById('todayPosts').textContent = todayCount;
        }
    } catch (error) {
        console.error('Error loading posts:', error);
        document.getElementById('postsList').innerHTML = '<div class="empty-state">Error loading posts</div>';
    }
}

function displayPosts(posts) {
    if (posts.length === 0) {
        document.getElementById('postsList').innerHTML = `
            <div class="empty-state">
                <h3>No posts found</h3>
                <p>Generate your first blog post to get started</p>
            </div>
        `;
        return;
    }
    
    const html = posts.map(post => `
        <div class="post-row">
            <div>
                <div class="post-title">${post.title}</div>
                <div class="post-meta">${post.excerpt.substring(0, 100)}...</div>
                <div class="post-meta" style="margin-top: 5px;">
                    <span style="color: #10b981;">üëÅÔ∏è ${post.view_count || 0} views</span>
                </div>
            </div>
            <div class="post-category">${post.category}</div>
            <div class="post-date">${new Date(post.published_at).toLocaleDateString()}</div>
            <div class="post-actions">
                <button class="btn btn-primary btn-small" onclick="editPost('${post.slug}')">Edit</button>
                <a href="/blog/${post.slug}" target="_blank" class="btn btn-success btn-small" style="text-decoration: none;">View</a>
                <button class="btn btn-danger btn-small" onclick="deletePost('${post.slug}')">Delete</button>
            </div>
        </div>
    `).join('');
    
    document.getElementById('postsList').innerHTML = html;
}

function filterPosts() {
    const searchTerm = document.getElementById('searchBox').value.toLowerCase();
    const filtered = allPosts.filter(post => 
        post.title.toLowerCase().includes(searchTerm) ||
        post.excerpt.toLowerCase().includes(searchTerm)
    );
    displayPosts(filtered);
}

function editPost(slug) {
    const post = allPosts.find(p => p.slug === slug);
    if (!post) return;
    
    currentEditSlug = slug;
    document.getElementById('editTitle').value = post.title;
    document.getElementById('editExcerpt').value = post.excerpt;
    document.getElementById('editCategory').value = post.category;
    
    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
    currentEditSlug = '';
}

// Form submission
document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const updatedData = {
        title: document.getElementById('editTitle').value,
        excerpt: document.getElementById('editExcerpt').value,
        category: document.getElementById('editCategory').value
    };
    
    try {
        const response = await fetch(`/api/blog/${currentEditSlug}/update`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Post updated successfully!');
            closeEditModal();
            refreshPosts();
        } else {
            alert('Error updating post: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error updating post: ' + error.message);
    }
});

async function deletePost(slug) {
    if (!confirm('Are you sure you want to delete this post?')) return;
    
    try {
        const response = await fetch(`/api/blog/${slug}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Post deleted successfully');
            refreshPosts();
        } else {
            alert('Error deleting post: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting post: ' + error.message);
    }
}

async function refreshPosts() {
    document.getElementById('postsList').innerHTML = '<div class="loading">Refreshing...</div>';
    await loadStats();
    await loadPosts();
}

async function generateNewPost() {
    const types = ['mortgage', 'investment', 'loan', 'insurance'];
    const type = prompt('Enter post type (mortgage, investment, loan, insurance):');
    
    if (!type || !types.includes(type)) {
        alert('Please enter a valid type');
        return;
    }
    
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';
        
        const response = await fetch('/api/publish-test-blog', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('New post generated successfully!');
            refreshPosts();
        } else {
            alert('Error generating post: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error generating post: ' + error.message);
    } finally {
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = '‚ú® Generate New Post';
    }
}

// Close modal on outside click
document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('editModal')) {
        closeEditModal();
    }
});
    </script>
</body>
</html>